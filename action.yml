name: "Ops ESLint"
description: "Run ESLint Flat Config inside a tooling container."
author: "Ricardo Malnati"

branding:
  icon: "check-circle"
  color: "blue"

inputs:
  path:
    description: "Path to lint (relative to repository root)."
    required: false
    default: "."
  eslint_args:
    description: "ESLint targets/flags appended to the command."
    required: false
    default: "."
  fix:
    description: "Enable --fix."
    required: false
    default: "false"
  max_warnings:
    description: "Fail when warning count is above this value (-1 disables)."
    required: false
    default: "-1"
  report_dir:
    description: "Directory (inside path) where the report file is written."
    required: false
    default: ".eslint"
  report_file:
    description: "Report filename generated by ESLint."
    required: false
    default: "eslint-report.json"
  report_formatter:
    description: "ESLint formatter used for the report file."
    required: false
    default: "json"
  build_image:
    description: "Build the local tooling image before running lint."
    required: false
    default: "true"
  image_tag:
    description: "Docker image tag used by the action."
    required: false
    default: "malnati-ops-eslint:local"
  fail_on_error:
    description: "Fail the action when ESLint exits non-zero."
    required: false
    default: "true"

outputs:
  report_path:
    description: "Path to the generated lint report file."
    value: ${{ steps.eslint.outputs.report_path }}
  error_count:
    description: "Total ESLint errors from JSON report."
    value: ${{ steps.eslint.outputs.error_count }}
  warning_count:
    description: "Total ESLint warnings from JSON report."
    value: ${{ steps.eslint.outputs.warning_count }}
  status:
    description: "Lint status (passed|failed)."
    value: ${{ steps.eslint.outputs.status }}
  exit_code:
    description: "Raw ESLint process exit code."
    value: ${{ steps.eslint.outputs.exit_code }}

runs:
  using: "composite"
  steps:
    - name: Run ESLint in tooling container
      id: eslint
      shell: bash
      env:
        INPUT_PATH: ${{ inputs.path }}
        INPUT_ESLINT_ARGS: ${{ inputs.eslint_args }}
        INPUT_FIX: ${{ inputs.fix }}
        INPUT_MAX_WARNINGS: ${{ inputs.max_warnings }}
        INPUT_REPORT_DIR: ${{ inputs.report_dir }}
        INPUT_REPORT_FILE: ${{ inputs.report_file }}
        INPUT_REPORT_FORMATTER: ${{ inputs.report_formatter }}
        INPUT_BUILD_IMAGE: ${{ inputs.build_image }}
        INPUT_IMAGE_TAG: ${{ inputs.image_tag }}
        INPUT_FAIL_ON_ERROR: ${{ inputs.fail_on_error }}
      run: bash "${{ github.action_path }}/assets/run.sh"
